#! /bin/sh -e

. /usr/share/debconf/confmodule

ETCDIR=/target/etc
LOGDIR=/target/var/log

ARCH=`udpkg --print-architecture`
PROTOCOL=
MIRROR=
DIRECTORY=
COMPONENTS=
DISTRIBUTION=sarge

if [ -f /cdrom/.disk/base_installable ]; then
    PROTOCOL=file
    MIRROR=""
    DIRECTORY="/cdrom/"
    if [ -s /cdrom/.disk/base_components ]; then
        COMPONENTS=`grep -v '^#' /cdrom/.disk/base_components | tr '\n' , | sed 's/,$//'`
    else
        COMPONENTS="*"
    fi

    if [ -s /cdrom/.disk/base_include ]; then
        INCLUDES=`grep -v '^#' /cdrom/.disk/base_include | tr '\n' , | sed 's/,$//'`
    fi

    if [ -s /cdrom/.disk/base_exclude ]; then
        EXCLUDES=`grep -v '^#' /cdrom/.disk/base_exclude | tr '\n' , | sed 's/,$//'`
    fi
else
    db_get mirror/protocol
    PROTOCOL="$RET"

    db_get mirror/$PROTOCOL/hostname
    MIRROR="$RET"

    db_get mirror/$PROTOCOL/directory
    DIRECTORY="$RET"

    if [ "$PROTOCOL" = "http" ]; then
        # try to find http proxy
        db_get mirror/http/proxy
        http_proxy="$RET" || true
        if [ "$http_proxy" ]; then
            export http_proxy
        fi
    fi

    COMPONENTS="main"
fi

if db_get mirror/distribution && [ "$RET" ] ; then
    DISTRIBUTION=$RET
fi

if [ -x /sbin/brltty -a -f /proc/cmdline ]; then
    if grep brltty= /proc/cmdline >/dev/null && \
       ps aux | grep -v grep | grep brltty >/dev/null; then
	if [ "${INCLUDES}" ]; then
	    INCLUDES="brltty,${INCLUDES}"
	else
	    INCLUDES="brltty"
	fi
    fi
fi

if [ "${INCLUDES}" ]; then
    INCLUDE="--include=${INCLUDES}"
fi
if [ "${EXCLUDES}" ]; then
    EXCLUDE="--exclude=${EXCLUDES}"
fi

unset DEBIAN_HAS_FRONTEND
unset DEBIAN_FRONTEND
unset DEBCONF_FRONTEND
unset DEBCONF_REDIR

test -d $ETCDIR || mkdir -p $ETCDIR
test -d $LOGDIR || mkdir -p $LOGDIR

cp /target/etc/fstab /target/etc/fstab.orig
echo "# UNCONFIGURED FSTAB FOR BASE SYSTEM" >> /target/etc/fstab

debootstrap \
    --components="${COMPONENTS}" \
    --boot-floppies \
    ${INCLUDE} ${EXCLUDE} \
    ${DISTRIBUTION} /target \
    "$PROTOCOL://$MIRROR$DIRECTORY" \
    3>&1 > $LOGDIR/debootstrap.log \
    2> $LOGDIR/debootstrap.err.log </dev/null

mv /target/etc/fstab.orig /target/etc/fstab

# Why is this here?  Why are the files moved into /target/? [pere 2003-02-07]
APTLISTDIR=/target/var/lib/apt/lists
if [ -f /cdrom/.disk/base_installable ]; then
    DEBOOTSTRAPLIST="$APTLISTDIR/debootstrap.invalid_dists_${DISTRIBUTION}"
else
    APTDIR=`echo $DIRECTORY | tr "/" "_"`
    DEBOOTSTRAPLIST="$APTLISTDIR/debootstrap.invalid_dists_${DISTRIBUTION}"
    APTLIST="$APTLISTDIR/${MIRROR}${APTDIR}_dists_${DISTRIBUTION}"

    mv ${DEBOOTSTRAPLIST}_Release ${APTLIST}_Release
    mv ${DEBOOTSTRAPLIST}_main_binary-${ARCH}_Packages ${APTLIST}_main_binary-${ARCH}_Packages
fi

# Copy the files from the CD, to avoid access problems in chroot
# environment.  This has to happen here, as debootstrap to not
# understand copy:, while apt-get do.
if [ file = "$PROTOCOL" ] ; then
    PROTOCOL=copy
fi

# sources.list use space to separate the components, not comma
COMPONENTS=`echo $COMPONENTS | tr , " "`
APTSOURCE="$PROTOCOL://$MIRROR$DIRECTORY"

echo "deb $APTSOURCE $DISTRIBUTION $COMPONENTS" > /target/etc/apt/sources.list

apt-update

if [ -f /var/lib/apt-install/queue ] ; then
    for pkg in `cat /var/lib/apt-install/queue` ; do
	apt-install $pkg || true
    done
fi

exit 0
